# This workflow uses actions that are not certified by GitHub. They are provided
# by a third-party and are governed by separate terms of service, privacy
# policy, and support documentation.

name: OpenSSF Scorecard
on:
  # 僅在預設分支上執行分析，避免寫入權限問題
  branch_protection_rule:
  schedule:
    - cron: '30 2 * * 0' # 每週日 02:30 UTC 執行
  push:
    branches: [ "main" ]
  workflow_dispatch:

# 宣告預設權限為唯讀
permissions: read-all

jobs:
  analysis:
    name: Scorecard 分析
    runs-on: ubuntu-latest
    permissions:
      # 需要寫入權限以上傳結果至 Security 標籤
      security-events: write
      # 需要讀取權限以擷取儲存庫的內容
      id-token: write
      contents: read
      actions: read

    steps:
      - name: "檢出程式碼"
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: "執行分析"
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: results.sarif
          results_format: sarif
          # （選用）"write" PAT 權限。如果未設定，將僅包含公開可見的 GitHub 資訊。
          # 這在私有儲存庫上執行時是必需的。
          repo_token: ${{ secrets.SCORECARD_TOKEN }}

          # 發佈結果至 OpenSSF REST API
          # 若要使用此功能，請啟用上方的 id-token 權限
          publish_results: true

      # 將結果上傳到 GitHub 的程式碼掃描儀表板
      - name: "上傳到程式碼掃描"
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2
        with:
          sarif_file: results.sarif
